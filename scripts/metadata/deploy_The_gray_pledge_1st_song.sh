#!/usr/bin/env bash
set -euo pipefail

# --- .env を自動読込（存在すれば / Linux & macOS 両対応） ---
if [ -f ".env.local" ]; then set -a; . ./.env.local; set +a; fi
if [ -f ".env" ]; then set -a; . ./.env; set +a; fi

: "${CREATE2_DEPLOYER:?Missing CREATE2_DEPLOYER}"
: "${RPC_URL:?Missing RPC_URL}"
: "${PRIVATE_KEY:?Missing PRIVATE_KEY}"
: "${PGIRLS_ERC20_ADDRESS:=${NEXT_PUBLIC_PGIRLS_ERC20_ADDRESS:-${NEXT_PUBLIC_PGIRLS:-}}}"
: "${TREASURY_ADDRESS:=${NEXT_PUBLIC_TREASURY:-${NEXT_PUBLIC_NFT_OWNER:-${OWNER:-${OWNER_ADDRESS:-}}}}}"
OWNER_ADDRESS=${NFT_OWNER:-${NEXT_PUBLIC_NFT_OWNER:-${TREASURY_ADDRESS:-${OWNER:-${OWNER_ADDRESS:-}}}}}
: "${OWNER_ADDRESS:?Missing owner address (NFT_OWNER/NEXT_PUBLIC_NFT_OWNER/TREASURY_ADDRESS/OWNER/OWNER_ADDRESS)}"
EXPECTED_OWNER="0xfF280ED2B0FF2Fb64E97137F82307042B4338C79"
EXPECTED_OWNER_LC=$(printf "%s" "$EXPECTED_OWNER" | tr "[:upper:]" "[:lower:]")
OWNER_ADDRESS_LC=$(printf "%s" "$OWNER_ADDRESS" | tr "[:upper:]" "[:lower:]")
if [ "$OWNER_ADDRESS_LC" != "$EXPECTED_OWNER_LC" ]; then
  echo "[warn] OWNER_ADDRESS と metadata owner が一致しません: $OWNER_ADDRESS vs $EXPECTED_OWNER" >&2
fi

# EIP-1559 非対応ノード向けの既定値
CAST_FLAGS=${CAST_FLAGS:---legacy}
GAS_PRICE_OPT=""
[ -n "${GAS_PRICE:-}" ] && GAS_PRICE_OPT="--gas-price ${GAS_PRICE}"

echo "Deploy The_gray_pledge_1st_song (predicted 0x8516de40D6b447488b1BeA2BE199Ddf349092dbc)"
echo "Deploying collection The_gray_pledge_1st_song -> 0x8516de40D6b447488b1BeA2BE199Ddf349092dbc"
cast send $CREATE2_DEPLOYER 'deploy(bytes32,bytes)' 0x5b8c9b2350c0d03dfa559f6966a76f662fbf8e091a90212600c29d3d5d92efb0 0x6080346200045c57601f906001600160401b03601f1962001c0e388190038581018316850191908483118684101762000446578086926060946040528339810103126200045c57620000518362000481565b926020936200007060406200006887850162000481565b930162000481565b6200007a62000461565b93600a8552691411da5c9b1cc813919560b21b878601526200009b62000461565b9760038952622823a760e91b888a0152855198878a1162000446576000998a54976001988981811c911680156200043b575b8c8210146200042757908b82868f81879611620003cc575b92505050508b908d8684116001146200036957926200035d575b5050600019600383901b1c191690881b178a555b805192888411620003495787548881811c911680156200033e575b8b8210146200032a579081848695949311620002d3575b508a9284116001146200027257508a9262000266575b5050600019600383901b1c191690851b1784555b6001600160a01b039182169283156200024d57600980546001600160a01b03198082168717909255909484929183167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08b80a31683600a541617600a551690600b541617600b55600c556040519060408201908282109082111762000239576101f4935060405273ff280ed2b0ff2fb64e97137f82307042b4338c79815201527501f4ff280ed2b0ff2fb64e97137f82307042b4338c796007556040516117779081620004978239f35b634e487b7160e01b84526041600452602484fd5b604051631e4fbdf760e01b815260048101899052602490fd5b0151905038806200015b565b888c528a8c20899590939291168c5b8c828210620002bc5750508411620002a2575b505050811b0184556200016f565b015160001960f88460031b161c1916905538808062000294565b8385015186558b9790950194938401930162000281565b9091929350888c528a8c208480870160051c8201928d881062000320575b9187968c92969594930160051c01915b8281106200031157505062000145565b8e81558796508b910162000301565b92508192620002f1565b634e487b7160e01b8c52602260045260248cfd5b90607f16906200012e565b634e487b7160e01b8b52604160045260248bfd5b015190503880620000ff565b91908d888d96169084805280852094905b828210620003b457505084116200039a575b505050811b018a5562000113565b015160001960f88460031b161c191690553880806200038c565b8385015186558e979095019493840193018f6200037a565b8394955080809492939452209181860160051c83019386106200041d575b859493910160051c909101908b908f5b8382106200040e578f9350889150620000e5565b81558594508c91018f620003fa565b92508192620003ea565b634e487b7160e01b8d52602260045260248dfd5b90607f1690620000cd565b634e487b7160e01b600052604160045260246000fd5b600080fd5b60408051919082016001600160401b038111838210176200044657604052565b51906001600160a01b03821682036200045c5756fe6080604081815260048036101561001557600080fd5b600092833560e01c90816301ffc9a714610acc5750806306fdde0314610a24578063081812fc146109e9578063095ea7b31461090d57806318e97fd1146108ed57806323b872dd146108d55780632a55205a14610897578063350eb8d91461073157806342842e0e1461070257806361d027b3146106d95780636352211e146106a857806370a0823114610653578063715018a6146105f357806375794a3c146105d457806377097fc8146103f957806385e0f38b146105ab5780638da5cb5b1461058257806395d89b411461049f578063a22cb465146103fe578063b7dc3b18146103f9578063b88d4fde14610386578063c87b56dd14610291578063e985e9c51461023f578063f0f44260146101c35763f2fde38b1461013657600080fd5b346101bf5760203660031901126101bf5761014f610bac565b90610158611042565b6001600160a01b039182169283156101a9575050600954826001600160601b0360a01b821617600955167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08380a380f35b51631e4fbdf760e01b8152908101849052602490fd5b8280fd5b50346101bf5760203660031901126101bf576101dd610bac565b6101e5611042565b6001600160a01b031691821561020d5750506001600160601b0360a01b600b541617600b5580f35b906020606492519162461bcd60e51b8352820152600c60248201526b7a65726f206164647265737360a01b6044820152fd5b50503461028d578060031936011261028d5760ff8160209361025f610bac565b610267610bc7565b6001600160a01b0391821683526005875283832091168252855220549151911615158152f35b5080fd5b5090346101bf576020918260031936011261038257356102b081611310565b508352600682528083209281518094829080546102cc8161106e565b9182855260019188838216918260001461035b57505060011461031d575b5050506103199392916102fe910386610c2b565b815161030981610bdd565b5251928284938452830190610b6c565b0390f35b8552868520879350859291905b82841061034357505050820101816102fe6103196102ea565b8054848b01860152899550889490930192810161032a565b60ff19168782015293151560051b860190930193508492506102fe915061031990506102ea565b8380fd5b83823461028d57608036600319011261028d576103a1610bac565b6103a9610bc7565b6044359060643567ffffffffffffffff81116103f557366023820112156103f5576103f2948160246103e093369301359101610c69565b926103ec8383836110a8565b3361134b565b80f35b8580fd5b610d2f565b5090346101bf57806003193601126101bf57610418610bac565b906024359182151580930361049b576001600160a01b03169283156104865750338452600560205280842083855260205280842060ff1981541660ff8416179055519081527f17307eab39ab6107e8899845ad3d59bd9653f200f220920489ca2b5937696c3160203392a380f35b836024925191630b61174360e31b8352820152fd5b8480fd5b50503461028d578160031936011261028d578051908260018054916104c38361106e565b8086529282811690811561055a57506001146104fe575b5050506104ec82610319940383610c2b565b51918291602083526020830190610b6c565b94508085527fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf65b828610610542575050506104ec82602061031995820101946104da565b80546020878701810191909152909501948101610525565b6103199750869350602092506104ec94915060ff191682840152151560051b820101946104da565b50503461028d578160031936011261028d5760095490516001600160a01b039091168152602090f35b50503461028d578160031936011261028d57600a5490516001600160a01b039091168152602090f35b50503461028d578160031936011261028d57602090600c549051908152f35b833461065057806003193601126106505761060c611042565b600980546001600160a01b0319811690915581906001600160a01b03167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a380f35b80fd5b509134610650576020366003190112610650576001600160a01b03610676610bac565b169283156106935750806020938392526003845220549051908152f35b91516322718ad960e21b815291820152602490fd5b50913461065057602036600319011261065057506106c860209235611310565b90516001600160a01b039091168152f35b50503461028d578160031936011261028d57600b5490516001600160a01b039091168152602090f35b50503461028d576103f29061071636610ce4565b9192519261072384610bdd565b8584526103ec8383836110a8565b5082346106505761074136610d19565b93909161074f8515156114fb565b61075883611310565b5061076283611310565b946001600160a01b038087169133831461086057610790816107876107a59389611494565b80939192611537565b918061084a575b5050883384600a5416611544565b8351916107b183610bdd565b8383523315610833576107c48633611254565b918216806107e3578551637e27328960e01b8152808901889052602490fd5b91889588928894036107ff575050506103f2929333903361134b565b516364283d7b60e01b81526001600160a01b0380881693820193845260208401949094529216604082015281906060010390fd5b8451633250574960e11b8152808801859052602490fd5b610859913386600a5416611544565b8980610797565b845162461bcd60e51b8152602081890152601160248201527020b63932b0b23c903a34329037bbb732b960791b6044820152606490fd5b50503461028d57610319906108b46108ae36610d19565b90611494565b91516001600160a01b03909116815260208101919091529081906040820190565b8334610650576103f26108e736610ce4565b916110a8565b8334610650576103f26108ff36610ca0565b90610908611042565b6115cb565b5090346101bf57806003193601126101bf57610927610bac565b9160243561093481611310565b331515806109d6575b806109ad575b610997576001600160a01b039485169482918691167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258880a48452602052822080546001600160a01b031916909117905580f35b835163a9fbf51f60e01b81523381850152602490fd5b506001600160a01b03811686526005602090815284872033885290528386205460ff1615610943565b506001600160a01b03811633141561093d565b50346101bf5760203660031901126101bf57918260209335610a0a81611310565b50825283528190205490516001600160a01b039091168152f35b50503461028d578160031936011261028d57805190828054610a458161106e565b8085529160019180831690811561055a5750600114610a70575050506104ec82610319940383610c2b565b80809650527f290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e5635b828610610ab4575050506104ec82602061031995820101946104da565b80546020878701810191909152909501948101610a97565b925050346101bf5760203660031901126101bf573563ffffffff60e01b81168091036101bf576020925063152a902d60e11b8114908115610b0f575b5015158152f35b632483248360e11b811491508115610b29575b5038610b08565b6380ac58cd60e01b811491508115610b5b575b8115610b4a575b5038610b22565b6301ffc9a760e01b14905038610b43565b635b5e139f60e01b81149150610b3c565b919082519283825260005b848110610b98575050826000602080949584010152601f8019910116010190565b602081830181015184830182015201610b77565b600435906001600160a01b0382168203610bc257565b600080fd5b602435906001600160a01b0382168203610bc257565b6020810190811067ffffffffffffffff821117610bf957604052565b634e487b7160e01b600052604160045260246000fd5b60a0810190811067ffffffffffffffff821117610bf957604052565b90601f8019910116810190811067ffffffffffffffff821117610bf957604052565b67ffffffffffffffff8111610bf957601f01601f191660200190565b929192610c7582610c4d565b91610c836040519384610c2b565b829481845281830111610bc2578281602093846000960137010152565b906040600319830112610bc257600435916024359067ffffffffffffffff8211610bc25780602383011215610bc257816024610ce193600401359101610c69565b90565b6060906003190112610bc2576001600160a01b03906004358281168103610bc257916024359081168103610bc2579060443590565b6040906003190112610bc2576004359060243590565b34610bc257610d3d36610ca0565b811590610d4a82156114fb565b600b546001600160a01b03939084161561100a57600c54926101f49081830291838304141715610ff457612710610d8391048092611537565b9080610f5d575b50610da19084600a541685600b5416903390611544565b6040918251610daf81610bdd565b6000948582523315610f4557610dc58333611254565b16610f2d57333b610e04575b50610ddc92506115cb565b600c5460018101809111610df057600c5580f35b634e487b7160e01b82526011600452602482fd5b90610e4292918451630a85bd0160e11b9182825233600483015287602483015283604483015260806064830152818060209788936084830190610b6c565b03818a335af1879181610ee9575b50610eaf57505050503d600014610ea6573d610e6b81610c4d565b90610e7884519283610c2b565b81528093823d92013e5b82519283610ea1578251633250574960e11b8152336004820152602490fd5b019050fd5b60609250610e82565b94959492935090916001600160e01b03191603610ed257610ddc92935038610dd1565b8351633250574960e11b8152336004820152602490fd5b9091508581813d8311610f26575b610f018183610c2b565b81010312610f2257516001600160e01b031981168103610f22579038610e50565b8780fd5b503d610ef7565b83516339e3563760e11b815260048101869052602490fd5b8451633250574960e11b815260048101879052602490fd5b6020600086600a541692604051838101916323b872dd60e01b835233602483015273ff280ed2b0ff2fb64e97137f82307042b4338c796044830152606482015260648152610faa81610c0f565b519082855af115610fe8576000513d610fdf5750803b155b15610d8a5760249060405190635274afe760e01b82526004820152fd5b60011415610fc2565b6040513d6000823e3d90fd5b634e487b7160e01b600052601160045260246000fd5b60405162461bcd60e51b815260206004820152601060248201526f151c99585cdd5c9e481b9bdd081cd95d60821b6044820152606490fd5b6009546001600160a01b0316330361105657565b60405163118cdaa760e01b8152336004820152602490fd5b90600182811c9216801561109e575b602083101461108857565b634e487b7160e01b600052602260045260246000fd5b91607f169161107d565b906001600160a01b03908116801561123b576000918483528460209260028452604093838587205416958691331515806111a2575b509060027fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef928461116f575b85835260038152888320805460010190558683525286812080546001600160a01b0319168517905580a4831682036111415750505050565b516364283d7b60e01b81526001600160a01b0392831660048201526024810193909352166044820152606490fd5b600087815260046020526040902080546001600160a01b0319169055848352600381528883208054600019019055611109565b919394509150806111fa575b156111be578792918691386110dd565b8488876111db576024915190637e27328960e01b82526004820152fd5b905163177e802f60e01b81523360048201526024810191909152604490fd5b50338614801561121f575b806111ae57508782526004815233848684205416146111ae565b5085825260058152848220338352815260ff8583205416611205565b604051633250574960e11b815260006004820152602490fd5b6000828152600260205260408120546001600160a01b03908116939284917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef91836112db575b1692836112c3575b84815260026020526040812080546001600160a01b0319168517905580a490565b838152600360205260408120600181540190556112a2565b600086815260046020526040902080546001600160a01b0319169055838552600360205260408520805460001901905561129a565b6000818152600260205260409020546001600160a01b0316908115611333575090565b60249060405190637e27328960e01b82526004820152fd5b90939192833b61135d575b5050505050565b604051630a85bd0160e11b8082526001600160a01b0393841660048301529583166024820152604481019190915260806064820152949216926020929185906113aa906084830190610b6c565b039483816000978189895af1869181611450575b5061141a575050503d600014611411573d6113d881610c4d565b906113e66040519283610c2b565b81528093823d92013e5b82519283610ea157604051633250574960e11b815260048101849052602490fd5b606092506113f0565b919450915063ffffffff60e01b160361143857503880808080611356565b60249060405190633250574960e11b82526004820152fd5b9091508481813d831161148d575b6114688183610c2b565b8101031261148957516001600160e01b0319811681036114895790386113be565b8680fd5b503d61145e565b6000908152600860205260409020549091906001600160a01b038082169160a01c9082156114e1575b506001600160601b031692838102938185041490151715610ff45761271090920490565b600754908116925060a01c90506001600160601b036114bd565b1561150257565b60405162461bcd60e51b815260206004820152600d60248201526c496e76616c696420707269636560981b6044820152606490fd5b91908203918211610ff457565b9260209160009160405190848201926323b872dd60e01b845260018060a01b039687809216602485015216604483015260648201526064815261158681610c0f565b519082865af115610fe8576000513d6115c257508082163b155b6115a8575050565b604051635274afe760e01b81529116600482015260249150fd5b600114156115a0565b91909160009080825260209160068352604081209085519067ffffffffffffffff821161172d576115fc835461106e565b601f81116116ea575b508490601f831160011461166657907ff8e1a15aba9398e019f0b49df1a4fde98ee17ae345cb5f6b5e2c27f5033e8ce796978361165b575b50508160011b916000199060031b1c19161790555b604051908152a1565b01519050388061163d565b9196601f198816848452868420935b8181106116d357509160019391897ff8e1a15aba9398e019f0b49df1a4fde98ee17ae345cb5f6b5e2c27f5033e8ce7999a94106116ba575b505050811b019055611652565b015160001960f88460031b161c191690553880806116ad565b929387600181928786015181550195019301611675565b838252858220601f840160051c810191878510611723575b601f0160051c01905b8181106117185750611605565b82815560010161170b565b9091508190611702565b634e487b7160e01b81526041600452602490fdfea2646970667358221220238ee6c97503ee2870459f428c3cc2b751ad9242f6c5820da4ccdc66bf7293e164736f6c63430008140033000000000000000000000000ff280ed2b0ff2fb64e97137f82307042b4338c790000000000000000000000004f37658cdfd8a91755a91428642d0094e4ca97f0000000000000000000000000ff280ed2b0ff2fb64e97137f82307042b4338c79 --rpc-url $RPC_URL --private-key $PRIVATE_KEY $CAST_FLAGS $GAS_PRICE_OPT
echo ""
echo "All done (The_gray_pledge_1st_song)."
